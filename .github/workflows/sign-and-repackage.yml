name: Sign and Repackage ZIP

on:
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
    inputs:
      zip_file:
        description: 'ZIP filename in unsign/ (e.g., 20260105_text.zip)'
        required: false
        type: string

jobs:
  process:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # UTF-8ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¯¾å¿œå¿…é ˆ

      - name: Verify Python version
        run: |
          python --version
          python -c "import sys; assert sys.version_info >= (3, 11), 'Python 3.11+ required for UTF-8 ZIP support'"

      - name: Process ZIP files
        run: |
          if [ -n "${{ inputs.zip_file }}" ]; then
            # ç‰¹å®šã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
            echo "Processing specific file: ${{ inputs.zip_file }}"
            python scripts/process_zip.py "unsign/${{ inputs.zip_file }}" signed/
          else
            # unsign/ å†…ã®å…¨ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
            echo "Processing all ZIP files in unsign/"
            python scripts/process_zip.py unsign/ signed/
          fi

      - name: List processed files
        run: |
          echo "ğŸ“¦ Processed files in signed/:"
          ls -lh signed/ || echo "No files generated"

      - name: Commit and push signed files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add signed/

          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add signed and repackaged ZIP [skip ci]"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-zips
          path: signed/*.zip
          retention-days: 30
